<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hayes Redline Mechanic Shop Repair Calculator</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://i.ibb.co/qFC7t6D9/HR.png">
  <link rel="apple-touch-icon" href="https://i.ibb.co/qFC7t6D9/HR.png">
  <meta name="theme-color" content="#0f172a">
  <style>
    :root{
      --brand:#2563eb; --accent:#fbbf24; --accent-2:#f59e0b;
      --ink:#0b1220; --muted:#64748b; --bg:#f6f8fb; --panel:#ffffff; --card:#ffffff; --chip:#f1f5f9; --border:#e2e8f0;
      --radius:16px; --shadow:0 10px 30px rgba(2,6,23,.08);
    }
    [data-theme="dark"]{
      --bg:#0b1220; --panel:#0f172a; --card:#0b1328; --chip:#0b1b3a; --border:#1e293b; --ink:#e6edf6; --muted:#93a4b8; --brand:#3b82f6; --accent:#fbbf24; --accent-2:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Arial}
    h1,h2,h3{margin:0}
    .container{max-width:1200px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:20px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:48px;height:48px;border-radius:12px;box-shadow:var(--shadow);display:grid;place-items:center;background:linear-gradient(135deg,var(--brand) 0 55%, var(--accent) 55% 100%);color:#0b1220;font-size:22px}

    /* Make form controls respect the theme */
    input, select, textarea {
      color: var(--ink);
      background: var(--chip);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 10px;
    }
    input::placeholder { color: var(--muted); }

    
    .brand h1{font-size:1.4rem;letter-spacing:.2px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius)}
    .panel h2{padding:16px 18px;border-bottom:1px solid var(--border);font-size:1rem}
    .content{padding:16px}
    .section{margin-bottom:16px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .card h3{font-size:1rem}
    .price{color:var(--brand);font-weight:800}
    .muted{color:var(--muted);font-size:.9rem}
    .qty{display:grid;grid-template-columns:32px 1fr 32px;align-items:center;gap:8px;margin-top:6px}
    .qty button{height:36px;border-radius:10px;border:1px solid var(--border);background:var(--chip);color:var(--ink);cursor:pointer;font-size:18px}
    .qty output{text-align:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--chip);color:var(--ink);cursor:pointer;font-weight:600;text-decoration:none}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--accent));border:none;color:#0b1220}
    .btn.block{width:100%}
    .btn.ghost{background:transparent}
    .toolrow{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .chip{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--muted);font-weight:700;font-size:.85rem}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .order-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:6px}
    .cart-item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:8px;border-bottom:1px dashed var(--border)}
    .cart-item:last-child{border-bottom:none}
    .small{font-size:.85rem;color:var(--muted)}
    .tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
    .tabs .btn[aria-selected="true"]{outline:2px solid var(--brand)}
    .summary{display:flex;flex-direction:column;gap:14px}
    .summary .row{display:flex;justify-content:space-between;align-items:center}
    .summary .row.total{font-size:1.2rem;font-weight:800}
    .discount{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .discount input[type="range"]{width:100%}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:transparent;border:2px solid var(--brand);color:var(--brand);border-radius:8px;padding:4px 8px;font-weight:800}
    .buy-row{display:grid;grid-template-columns:1.2fr .8fr .8fr .8fr;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed var(--border)}
    .buy-row:last-child{border-bottom:none}
    .buy-row .right{text-align:right}
    .buy-input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--chip);color:var(--ink)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">ðŸ”§</div>
        <div>
          <h1>Hayes Redline Mechanic Shop Repair Calculator</h1>
          <div class="muted">Pick parts, apply discounts, and get an exact total.</div>
        </div>
      </div>
      <div class="toolrow">
        <!-- Employee input -->
        <label class="chip" style="display:flex;align-items:center;gap:8px">
          <span>Employee</span>
          <input id="empName" placeholder="e.g., Samii" style="border:1px solid var(--border);background:var(--chip);padding:6px 10px;border-radius:10px;width:160px;">
        </label>

        <span class="chip">Autosaves</span>
        <button class="btn ghost" id="themeBtn" aria-pressed="false" title="Toggle dark mode">ðŸŒ™ Dark</button>
        <button class="btn ghost" id="resetBtn">Clear All</button>
        <button class="btn primary" id="checkoutBtn">Checkout</button>
      </div>
    </header>

    <div class="flagbar" aria-hidden="true" style="height:10px;border-radius:8px;overflow:hidden;margin-bottom:18px;">
      <div style="display:flex;height:100%;">
        <div style="flex:1;background:var(--brand)"></div>
        <div style="flex:1;background:var(--accent)"></div>
        <div style="flex:1;background:var(--brand)"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Menu -->
      <section class="panel">
        <h2>Menu</h2>
        <div class="content">
          <div class="section">
            <h3 style="margin:0 0 8px 0">Body Parts</h3>
            <div class="cards" id="damage"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Materials & Shop Items</h3>
            <div class="cards" id="materials"></div>
          </div>
        </div>
      </section>

      <!-- Right: Orders -->
      <aside class="panel">
        <h2>Orders</h2>
        <div class="content">
          <div class="tabs" role="tablist" aria-label="Order panels">
            <button class="btn" data-tab="summary" aria-selected="true">ðŸ§¾ Summary</button>
            <button class="btn" data-tab="history" aria-selected="false">ðŸ“œ History</button>
            <button class="btn" data-tab="ingredients" aria-selected="false">ðŸ§º Materials List</button>
            <button class="btn" data-tab="buy" aria-selected="false">ðŸ’µ Buy Materials</button>
          </div>

          <!-- SUMMARY TAB -->
          <div id="tab-summary" role="tabpanel">
            <div id="cart" class="order-card">
              <div class="cart-item muted">Cart is empty. Add items from the left.</div>
            </div>

            <div class="divider"></div>

            <div class="discount">
              <label for="discountRange">Discount</label>
              <div><span id="discountLabel" class="kbd">0%</span></div>
              <input id="discountRange" type="range" min="0" max="100" step="5" value="0" />
            </div>

            <div class="summary" style="margin-top:12px;">
              <div class="row"><span>Subtotal</span><strong id="subtotal">$0.00</strong></div>
              <div class="row"><span>Discount</span><strong id="discount">-$0.00</strong></div>
              <div class="row total"><span>Total</span><strong id="total">$0.00</strong></div>
            </div>

            <div class="right-actions" style="margin-top:12px;">
              <button class="btn primary block" id="checkoutBtn2">Checkout</button>
              <button class="btn ghost block" id="resetBtn2">Clear All</button>
            </div>
          </div>

          <!-- HISTORY TAB -->
          <div id="tab-history" role="tabpanel" hidden>
            <div class="toolrow" style="margin-bottom:8px;">
              <label class="chip" style="display:flex;align-items:center;gap:8px">
                <span>Filter</span>
                <select id="empFilter" style="border:1px solid var(--border);background:var(--chip);padding:6px 10px;border-radius:10px;">
                  <option value="__all__">All employees</option>
                </select>
              </label>
              <button class="btn" id="refreshHistoryBtn">Refresh</button>
            </div>

            <div class="summary" style="gap:8px; margin-bottom:8px;">
              <div class="row"><span>Orders served today</span><strong id="ordersToday">0</strong></div>
              <div class="row"><span>Orders served overall</span><strong id="ordersOverall">0</strong></div>
            </div>
            <div id="historyList" class="summary" style="gap:12px;"></div>
            <div class="right-actions" style="margin-top:12px;">
              <button class="btn ghost" id="clearHistoryBtn">Clear History</button>
            </div>
          </div>

          <!-- MATERIALS TAB -->
          <div id="tab-ingredients" role="tabpanel" hidden>
            <div class="small muted" style="margin-bottom:6px;">
              Auto-aggregated from your current cart using each item's recipe.
            </div>
            <div id="ingredientList" class="order-card" style="padding:12px;">
              <div class="muted">No items yet.</div>
            </div>
            <div class="toolrow" style="margin-top:10px;justify-content:flex-end">
              <button class="btn" id="copyIngBtn">Copy List</button>
              <button class="btn" id="exportIngBtn">Export CSV</button>
            </div>
          </div>

          <!-- BUY MATERIALS TAB -->
          <div id="tab-buy" role="tabpanel" hidden>
            <div class="small muted" style="margin-bottom:6px;">
              Enter how many units a seller brings you. Payouts use your shop buy rates.
            </div>

            <div class="order-card" id="buyRows" style="padding:8px;"></div>

            <div class="summary" style="margin-top:12px;">
              <div class="row"><span>Subtotal to Pay</span><strong id="buySubtotal">$0.00</strong></div>
              <div class="row total"><span>Total to Pay</span><strong id="buyTotal">$0.00</strong></div>
            </div>

            <div class="toolrow" style="margin-top:12px;justify-content:flex-end;">
              <button class="btn" id="copyBuyBtn">Copy Breakdown</button>
              <button class="btn ghost" id="clearBuyBtn">Clear</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ---------- Google Sheets API (Apps Script) ----------
    //  Web App URL:
    const SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbxF74H41h8mC26IGBWzjcuoByzZwxnvZyGw86Hxh4NXtj_67XuK6hKhklhIigmGGcpXUQ/exec';
    const SHEETS_API_KEY = '';

    // ---------- Data ----------
    const MENU = {
      damage: [
        { id:'dm-window', name:'ðŸ’¥Window', price:45,  type:'damage', recipe:{'Glass':1} },
        { id:'dm-door',   name:'ðŸšªDoor',   price:75,  type:'damage', recipe:{'Scrap':1} },
        { id:'dm-hood',   name:'ðŸ›¡ï¸Hood',  price:75,  type:'damage', recipe:{'Scrap':1} },
        { id:'dm-trunk',  name:'ðŸ“¦Trunk',  price:75,  type:'damage', recipe:{'Scrap':1} },
        { id:'dm-tire',   name:'âš«Tire',   price:20,  type:'damage', recipe:{'Rubber':1} },
      ],
      materials: [
        { id:'mat-glass',   name:'ðŸ’ŽGlass',      price:45,  type:'material', recipe:{'Glass':1} },
        { id:'mat-scrap',   name:'ðŸ”©Scrap',      price:75,  type:'material', recipe:{'Scrap':1} },
        { id:'mat-alum',    name:'ðŸ§±Aluminum',   price:100, type:'material', recipe:{'Aluminum':1} },
        { id:'mat-steel',   name:'ðŸ”§Steel',      price:125, type:'material', recipe:{'Steel':1} },
        { id:'mat-rubber',  name:'ðŸ§½Rubber',     price:20,  type:'material', recipe:{'Rubber':1} },
        { id:'shop-repair', name:'ðŸ§°Repair Kit', price:600, type:'material', recipe:{'Aluminum':2,'Scrap':2,'Glass':2,'Rubber':4} },
        { id:'shop-oil',    name:'ðŸ›¢ï¸Motor Oil',  price:600, type:'material', recipe:{'Motor Oil':1} },
      ]
    };

    const BUY_RATES = [
      { key:'Rubber',   icon:'ðŸ§½', unit:10 },
      { key:'Glass',    icon:'ðŸ’Ž', unit:30 },
      { key:'Scrap',    icon:'ðŸ”©', unit:50 },
      { key:'Aluminum', icon:'ðŸ§±', unit:70 },
      { key:'Steel',    icon:'ðŸ”§', unit:90 },
    ];

    const RECIPE_MAP = Object.fromEntries(
      [...MENU.damage, ...MENU.materials].map(x => [x.id, x.recipe||{}])
    );
    const currency = n => `$${n.toFixed(2)}`;

    // ---------- State ----------
    const STATE_KEY = 'hayes_state_blueyellow_v1';
    const HIST_KEY  = 'hayes_history_blueyellow_v1';

    const state = {
      cart:[],
      discountPct:0,
      history:[],
      buy:{}
    };

    try{
      const saved = JSON.parse(localStorage.getItem(STATE_KEY)||'{}');
      const savedHist = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
      if(Array.isArray(savedHist)) state.history = savedHist;
      if(saved){
        if(Array.isArray(saved.cart)) state.cart = saved.cart;
        if(typeof saved.discountPct==='number') state.discountPct = saved.discountPct;
        if(saved.buy && typeof saved.buy==='object') state.buy = saved.buy;
        const t = localStorage.getItem('hayes_theme')||'light';
        document.documentElement.setAttribute('data-theme', t);
      }
    }catch{}

    BUY_RATES.forEach(r => { if(typeof state.buy[r.key]!=='number') state.buy[r.key]=0; });

    const persist = () => localStorage.setItem(STATE_KEY, JSON.stringify(state));
    const persistHistory = () => localStorage.setItem(HIST_KEY, JSON.stringify(state.history));

    // ---------- Employee name memory ----------
    const empInput = document.getElementById('empName');
    empInput.value = localStorage.getItem('hayes_emp') || '';
    empInput.addEventListener('input', () =>
      localStorage.setItem('hayes_emp', empInput.value.trim())
    );
    const currentEmployee = () => (empInput.value || 'Unknown').trim();

    // ---------- Google Sheets helpers ----------
    async function fetchSharedHistory() {
      try{
        const url = new URL(SHEETS_API_URL);
        url.searchParams.set('action', 'list');
        if (SHEETS_API_KEY) url.searchParams.set('key', SHEETS_API_KEY);

        const res = await fetch(url.toString(), { method: 'GET' });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Failed to fetch history');

        state.history = (data.data || []).map(row => ({
          id: Number(row.timestamp_ms),
          items: JSON.parse(row.items_json || '[]'),
          discountPct: Number(row.discountPct || 0),
          subtotal: Number(row.subtotal || 0),
          total: Number(row.total || 0),
          employee: row.employee || 'Unknown'
        }));
        persistHistory();
        populateEmpFilter();
        renderHistory();
      }catch(e){
        console.error(e);
        // keep local if fetch fails
        populateEmpFilter();
        renderHistory();
      }
    }

    async function createSharedOrder(payload){
      const res = await fetch(SHEETS_API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ action:'create', key:SHEETS_API_KEY, ...payload })
      });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || 'Sheets write failed');
    }

    async function deleteSharedOrder(id){
      const res = await fetch(SHEETS_API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ action:'delete', key:SHEETS_API_KEY, id })
      });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || 'Delete failed');
    }

    // ---------- Cards ----------
    function cardHTML(item){
      return `
        <article class="card">
          <h3>${item.name}</h3>
          <div class="toolrow" style="justify-content:space-between;">
            <span class="price">${currency(item.price)}</span>
            <div class="qty">
              <button aria-label="decrease">âˆ’</button>
              <output>1</output>
              <button aria-label="increase">+</button>
            </div>
          </div>
          <button class="btn" data-add="${item.id}">Add</button>
        </article>`;
    }

    function renderCards(){
      const damage = document.getElementById('damage');
      const materials = document.getElementById('materials');
      const make = arr => arr.map(cardHTML).join('');
      damage.innerHTML = make(MENU.damage);
      materials.innerHTML = make(MENU.materials);

      const all = [...MENU.damage, ...MENU.materials];
      document.querySelectorAll('.cards .card').forEach(card=>{
        let count=1;
        const out=card.querySelector('output');
        card.querySelector('button[aria-label="decrease"]').addEventListener('click',()=>{count=Math.max(1,count-1);out.value=count;});
        card.querySelector('button[aria-label="increase"]').addEventListener('click',()=>{count++;out.value=count;});
        const addId = card.querySelector('[data-add]').getAttribute('data-add');
        const item = all.find(i=>i.id===addId);
        card.querySelector('[data-add]').addEventListener('click',()=>{
          addToCart({ id:item.id, name:item.name, unitPrice:item.price, qty:count, type:item.type });
        });
      });
    }

    // ---------- Cart ----------
    function renderCart(){
      const cart = document.getElementById('cart');
      if(!state.cart.length){
        cart.innerHTML = `<div class="cart-item muted">Cart is empty. Add items from the left.</div>`;
        return;
      }
      cart.innerHTML = state.cart.map((l,idx)=>`
        <div class="cart-item">
          <div>
            <div><strong>${l.name}</strong></div>
            <div class="small">${currency(l.unitPrice)} each</div>
          </div>
          <div class="qty">
            <button data-dec="${idx}">âˆ’</button>
            <output>${l.qty}</output>
            <button data-inc="${idx}">+</button>
          </div>
          <div><strong>${currency(l.unitPrice*l.qty)}</strong></div>
        </div>
      `).join('');

      cart.querySelectorAll('[data-inc]').forEach(b=>b.addEventListener('click',()=>{
        const i=+b.getAttribute('data-inc'); state.cart[i].qty++; persist(); renderCart(); renderTotals(); renderIngredients();
      }));
      cart.querySelectorAll('[data-dec]').forEach(b=>b.addEventListener('click',()=>{
        const i=+b.getAttribute('data-dec'); state.cart[i].qty--; if(state.cart[i].qty<=0) state.cart.splice(i,1); persist(); renderCart(); renderTotals(); renderIngredients();
      }));
    }

    function addToCart(line){
      const key = `${line.id||line.name}|${line.unitPrice}|${line.type||''}`;
      const found = state.cart.find(l => `${l.id||l.name}|${l.unitPrice}|${l.type||''}`===key);
      if(found) found.qty += line.qty; else state.cart.push(line);
      persist(); renderCart(); renderTotals(); renderIngredients();
    }

    // ---------- Totals ----------
    function renderTotals(){
      const subtotal = state.cart.reduce((s,l)=>s + l.unitPrice*l.qty, 0);
      const manual = +(subtotal * (state.discountPct/100)).toFixed(2);
      const total = subtotal - manual;

      document.getElementById('subtotal').textContent = currency(subtotal);
      document.getElementById('discount').textContent = `-${currency(manual)}`;
      document.getElementById('total').textContent = currency(total);
    }

    // ---------- Discount slider ----------
    const range=document.getElementById('discountRange'); const discountLabel=document.getElementById('discountLabel');
    function renderDiscount(){ range.value=state.discountPct; discountLabel.textContent = `${state.discountPct}%`; }
    range.addEventListener('input',()=>{ state.discountPct=+range.value; persist(); renderTotals(); discountLabel.textContent = `${state.discountPct}%`; });

    // ---------- Employee Filter ----------
    const empFilter = document.getElementById('empFilter');
    function populateEmpFilter(){
      if(!empFilter) return;
      const current = empFilter.value || '__all__';
      const names = Array.from(new Set(state.history.map(h => (h.employee||'Unknown').trim()))).sort((a,b)=>a.localeCompare(b));
      empFilter.innerHTML = `<option value="__all__">All employees</option>` + names.map(n => `<option value="${n}">${n}</option>`).join('');
      if([...empFilter.options].some(o=>o.value===current)) empFilter.value = current;
    }
    empFilter?.addEventListener('change', renderHistory);

    function getFilteredHistory(){
      const sel = empFilter?.value || '__all__';
      return sel==='__all__' ? state.history : state.history.filter(h => (h.employee||'Unknown')===sel);
    }

    // ---------- History ----------
    function ordersServedCounters(view = getFilteredHistory()){
      const todayStr=new Date().toDateString();
      const today=view.filter(h=> new Date(h.id).toDateString()===todayStr).length;
      const overall=view.length;
      document.getElementById('ordersToday').textContent=today;
      document.getElementById('ordersOverall').textContent=overall;
    }

    function renderHistory(){
      const view = getFilteredHistory();
      ordersServedCounters(view);
      const list=document.getElementById('historyList');
      if(!view.length){ list.innerHTML='<div class="muted">No past orders yet for this filter.</div>'; return; }
      list.innerHTML = view.map(h=>`
        <article class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div>
              <div><strong>${new Date(h.id).toLocaleString()}</strong></div>
              <div class="small">
                ${h.items.length} item(s) â€¢ Discount ${h.discountPct}% â€¢
                <strong>Employee:</strong> ${h.employee || 'Unknown'}
              </div>
            </div>
            <div><strong>${currency(h.total)}</strong></div>
          </div>
          <details class="small" style="margin-top:6px;">
            <summary>View items</summary>
            <ul style="margin:6px 0 0 16px;">
              ${h.items.map(i=>`<li>${i.qty}Ã— ${i.name} â€” ${currency(i.lineTotal)}</li>`).join('')}
            </ul>
          </details>
          <div class="toolrow" style="justify-content:flex-end;">
            <button class="btn" data-reorder="${h.id}">Reorder</button>
            <button class="btn ghost" data-delete="${h.id}">Delete</button>
          </div>
        </article>
      `).join('');

      // Reorder
      list.querySelectorAll('[data-reorder]').forEach(btn=>btn.addEventListener('click',()=>{
        const id=+btn.getAttribute('data-reorder');
        const h=state.history.find(x=>x.id===id); if(!h) return;
        h.items.forEach(it => addToCart({ id:it.id||null, name:it.name, unitPrice:it.unit, qty:it.qty, type:it.type||'material' }));
      }));

      // Delete (shared)
      list.querySelectorAll('[data-delete]').forEach(btn=>btn.addEventListener('click', async ()=>{
        const id = +btn.getAttribute('data-delete');
        if(!confirm('Delete this order for everyone?')) return;
        try{
          await deleteSharedOrder(id);
          await fetchSharedHistory();
        }catch(e){
          console.error(e);
          alert('Could not delete shared order.');
        }
      }));
    }

    document.getElementById('clearHistoryBtn').addEventListener('click',()=>{
      alert('Shared history lives in Google Sheets (tab "Orders"). To clear globally, delete rows there or use Delete per order.');
    });

    // ---------- Tabs ----------
    const tabButtons=document.querySelectorAll('[data-tab]');
    function selectTab(which){
      document.getElementById('tab-summary').hidden = which!=='summary';
      document.getElementById('tab-history').hidden = which!=='history';
      document.getElementById('tab-ingredients').hidden = which!=='ingredients';
      document.getElementById('tab-buy').hidden = which!=='buy';
      tabButtons.forEach(b=>b.setAttribute('aria-selected', String(b.getAttribute('data-tab')===which)));
      if(which==='ingredients') renderIngredients();
      if(which==='history'){ populateEmpFilter(); renderHistory(); }
      if(which==='buy') renderBuyTab();
    }
    tabButtons.forEach(b=>b.addEventListener('click',()=>selectTab(b.getAttribute('data-tab'))));

    // ---------- Materials aggregation ----------
    function aggregateIngredients(){
      const tally={};
      const add=(n,x=1)=>{ if(!n) return; tally[n]=(tally[n]||0)+x; };
      state.cart.forEach(line=>{
        const rec = RECIPE_MAP[line.id] || {};
        for(const [ing,c] of Object.entries(rec)) add(ing, c*line.qty);
      });
      return tally;
    }
    function renderIngredients(){
      const wrap=document.getElementById('ingredientList');
      const entries=Object.entries(aggregateIngredients()).sort((a,b)=>a[0].localeCompare(b[0]));
      if(!entries.length){ wrap.innerHTML='<div class="muted">No items yet.</div>'; return; }
      wrap.innerHTML = entries.map(([n,c])=>`<div style="display:grid;grid-template-columns:1fr auto;gap:8px;padding:6px 0;border-bottom:1px dashed var(--border)"><div>${n}</div><div><strong>x${c}</strong></div></div>`).join('');
    }
    document.getElementById('copyIngBtn')?.addEventListener('click',()=>{
      const txt=Object.entries(aggregateIngredients()).sort((a,b)=>a[0].localeCompare(b[0])).map(([n,c])=>`- ${n} x${c}`).join('\n');
      navigator.clipboard.writeText(txt).then(()=>alert('Materials copied!'));
    });
    document.getElementById('exportIngBtn')?.addEventListener('click',()=>{
      const rows=[["Material","Count"],...Object.entries(aggregateIngredients()).sort((a,b)=>a[0].localeCompare(b[0]))];
      const csv=rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='hayes_materials.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // ---------- Checkout / Reset ----------
    async function checkout(){
      if(!state.cart.length){ alert('Cart is empty.'); return; }
      const subtotal=state.cart.reduce((s,l)=>s+l.unitPrice*l.qty,0);
      const manual=+(subtotal*(state.discountPct/100)).toFixed(2);
      const total=+(subtotal-manual).toFixed(2);

      const entry = {
        id: Date.now(),
        items: state.cart.map(l=>({
          id:l.id||null, name:l.name, qty:l.qty, unit:l.unitPrice,
          type:l.type||'material', lineTotal:+(l.unitPrice*l.qty).toFixed(2)
        })),
        discountPct: state.discountPct,
        subtotal:+subtotal.toFixed(2),
        total,
        employee: currentEmployee()
      };

      try{
        await createSharedOrder({
          id: entry.id,
          items: entry.items,
          subtotal: entry.subtotal,
          discountPct: entry.discountPct,
          total: entry.total,
          employee: entry.employee
        });
        await fetchSharedHistory();
      }catch(e){
        console.error(e);
        alert('Could not save to Google Sheets. Check your Web App URL / permissions.');
      }finally{
        state.cart=[]; state.discountPct=0;
        persist(); renderAll(); selectTab('summary');
      }
    }

    function resetAll(){ state.cart=[]; state.discountPct=0; persist(); renderAll(); renderIngredients(); }

    document.getElementById('checkoutBtn').addEventListener('click',checkout);
    document.getElementById('checkoutBtn2').addEventListener('click',checkout);
    document.getElementById('resetBtn').addEventListener('click',resetAll);
    document.getElementById('resetBtn2').addEventListener('click',resetAll);

    // ---------- Theme ----------
    const themeBtn=document.getElementById('themeBtn');
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme',t);
      localStorage.setItem('hayes_theme',t);
      themeBtn.textContent=t==='dark'?'â˜€ï¸ Light':'ðŸŒ™ Dark';
      themeBtn.setAttribute('aria-pressed',t==='dark');
    }
    applyTheme(localStorage.getItem('hayes_theme')||'light');
    themeBtn.addEventListener('click',()=>{
      const next=(localStorage.getItem('hayes_theme')||'light')==='light'?'dark':'light';
      applyTheme(next);
    });

    // ---------- Buy Materials ----------
    function renderBuyTab(){
      const wrap = document.getElementById('buyRows');
      wrap.innerHTML = `
        <div class="buy-row small muted" style="font-weight:700;">
          <div>Material</div><div class="right">Unit</div><div class="right">Qty</div><div class="right">Line</div>
        </div>
        ${BUY_RATES.map(r=>`
          <div class="buy-row" data-key="${r.key}">
            <div><strong>${r.icon} ${r.key}</strong></div>
            <div class="right">${currency(r.unit)}</div>
            <div><input class="buy-input" type="number" min="0" step="1" inputmode="numeric" value="${state.buy[r.key]||0}" aria-label="${r.key} quantity"></div>
            <div class="right"><strong class="lineTotal">$0.00</strong></div>
          </div>
        `).join('')}
      `;
      wrap.querySelectorAll('.buy-row[data-key]').forEach(row=>{
        const key   = row.getAttribute('data-key');
        const input = row.querySelector('input.buy-input');
        const line  = row.querySelector('.lineTotal');
        const unit  = BUY_RATES.find(x=>x.key===key)?.unit || 0;
        const recalc = ()=>{
          const qty = Math.max(0, parseInt(input.value || '0', 10));
          state.buy[key] = qty;
          persist();
          line.textContent = currency(qty * unit);
          renderBuyTotals();
        };
        input.addEventListener('input', recalc);
        input.addEventListener('change', recalc);
        recalc();
      });
      document.getElementById('clearBuyBtn')?.addEventListener('click',()=>{
        BUY_RATES.forEach(r=>state.buy[r.key]=0);
        persist();
        renderBuyTab();
      });
      document.getElementById('copyBuyBtn')?.addEventListener('click',()=>{
        const lines = BUY_RATES.map(r=>{
          const q = state.buy[r.key]||0;
          if(!q) return null;
          const total = q*r.unit;
          return `${r.key}: ${q} Ã— ${currency(r.unit)} = ${currency(total)}`;
        }).filter(Boolean);
        const grand = currency(calcBuySubtotal());
        const txt = (lines.length? lines.join('\n')+'\n':'')+`Total to Pay: ${grand}`;
        navigator.clipboard.writeText(txt).then(()=>alert('Payout breakdown copied!'));
      });
      renderBuyTotals();
    }

    function calcBuySubtotal(){ return BUY_RATES.reduce((s,r)=> s + (state.buy[r.key]||0)*r.unit, 0); }
    function renderBuyTotals(){
      const sub = calcBuySubtotal();
      document.getElementById('buySubtotal').textContent = currency(sub);
      document.getElementById('buyTotal').textContent    = currency(sub);
    }

    // ---------- Init ----------
    function renderAll(){ renderCards(); renderCart(); renderTotals(); renderDiscount(); renderHistory(); }
    renderAll();
    fetchSharedHistory();
    document.getElementById('refreshHistoryBtn')?.addEventListener('click', ()=> fetchSharedHistory());
  </script>
</body>
</html>
